\documentclass{amsart}

% my notation
\newcommand{\col}{\chi}
\newcommand{\colt}{\tilde{\chi}}
\newcommand{\subcol}{\chi'}
\newcommand{\altcol}{\chi^{\dag}}
\newcommand{\subcolt}{\tilde{\chi}'}
\newcommand{\symmdiff}{\Delta}
\newcommand{\colorS}{\mathcal{C}}
\newcommand{\subcolS}{\mathsf{Sub}}
\newcommand{\subcolST}{\subcolS_{L(T)}}
\newcommand{\subunion}{\sqcup}
\newcommand{\treecut}{\Psi}
\newcommand{\cut}{\kappa}
\newcommand{\bad}{\beta}

% my operator names
\newcommand{\rk}{\operatorname{rk}}
\newcommand{\subrk}{\operatorname{subrk}}
\newcommand{\minsubrk}{\subrk_{\min}}
\newcommand{\mrca}{\sup}
\newcommand{\opt}[1]{\overset{\circ}{#1}}
\newcommand{\mlst}{\operatorname{mlst}}
\newcommand{\Bell}{\operatorname{Bell}}
\newcommand{\diam}{\operatorname{diam}}

% others' notation
\newcommand{\nbadcolors}{n_c^*}
% theorems, etc
\newtheorem{lemma}{Lemma}
\newtheorem{prop}{Proposition}
\newtheorem{theorem}{Theorem}
\newtheorem{problem}{Problem}
\newtheorem{defn}{Definition}
\newtheorem{obs}{Observation}


\begin{document}

\section{Introduction}

Definitions: induced subtree and rooted subtree

Given a tree $T$, let $N(T)$, $E(T)$, and $L(T)$ denote the nodes, edges, and leaves of $T$.

Given a set $S$, let $2^S$ denote the set of subsets of $S$.

\section{Finding a tree that does not violate taxonomic assignments}

\subsection{Agreement with a complete taxonomic tree}
This is Maximum Compatible Subtree (MCST).
When degree is bounded, it is polynomial, but is otherwise NP-complete \cite{HeinEaComparingTrees96}.

\subsection{Agreement with leaf taxonomic assignments}

\subsubsection{Introduction}

For the purposes of this paper, a ``color set'' will be an arbitrary finite set.
A node coloring of a tree $S$ is defined to be a mapping from a subset of the nodes of the tree to the colors.
A leaf coloring is defined to be a node coloring with domain a subset of the leaves.
A multicoloring is defined to be a map from the edges of the tree to subsets of the colors.
We say that a color $c$ is cut by an edge $e$ if $e$ lies in the subtree induced by the leaves of color $c$.

\begin{defn}
  Let $T$ be a rooted tree, and let $F \subset L(S)$.
  A leaf coloring is a map $\col: F \rightarrow C$.
  It is said to be complete if $F = L(T)$.
\end{defn}

\begin{defn}
  Given a coloring $\col$ on a rooted tree $S$, an induced multicoloring is the map $\colt: E(T) \rightarrow 2^C$
  such that $\colt(e)$ is the (potentially empty) set of colors which are cut by that edge.
\end{defn}

Define the badness $\bad(\col)$ of a coloring $\col$ to be $\max_{e \in E(T)} |\colt(e)| $ for all $e$.
We say that a coloring is convex if it has badness equal to zero or one.

\begin{defn}
  A subcoloring of a leaf coloring $\chi: F \rightarrow C$ is a coloring $\nu: G \rightarrow C$ with $G \subset F$ such that $\nu$ agrees with $\col$ on the domain of $\nu$.
  Let $\subcolS(\col)$ be the set of subcolorings of a given coloring $\col$.
  Let $\subcolS_D(\col)$ be the set of subcolorings with domain $D$.
\end{defn}
These are partially ordered by inclusion of domains.
The size of a subcoloring is defined to be the size of its domain.

For two colorings $\col_1$ and $\col_2$ with disjoint domains we can make a coloring on the union of their domains in the obvious way, which will be denoted $\col_1 \sqcup \col_2$.

\begin{problem}
\label{prob:subcolor}
  Given a leaf coloring $\col$ on a tree $T$, find a largest convex subcoloring in $\subcolS(\col)$.
\end{problem}

\subsubsection{Previous work}
The foundational work in this area was done by Moran and Snir \cite{MoranSnirConvexApprox07,MoranSnirConvexHard08}.
Their work is phrased in terms of ``convex recoloring,'' i.e. finding the minimal number of changes in a coloring in order to obtain one that is convex.
The recoloring definition allows replacement of one color with another as well as ``uncoloring'': the replacement of a color with no color at all.

It is not difficult to see that it suffices to consider just uncolorings.
Indeed, any minimal recoloring can be turned into a convex uncoloring of the same cardinality by uncoloring all of the colors that get changed.
Conversely, any uncoloring can be turned into a convex recoloring by taking, for every uncolored node, the color of the closest colored node.
For this reason, we simply consider subcolorings in this paper.

Moran and Snir investigate both the case of leaf coloring investigated here as well as the case of coloring all of the nodes of a tree.
They also consider non-uniform recoloring cost functions.
In all settings, they demonstrate that the relevant recoloring problem is NP-hard.
They also demonstrate fixed parameter tractablity (FPT) of the problems.

Their solution to the leaf recoloring problem is $O(n^4 \nbadcolors \Bell(\nbadcolors))$, where $\nbadcolors$ is the number of ``bad'' colors,
i.e. the number of colors which violate convexity (if we take the induced coloring on the tree, then cut by it, then
$\nbadcolors$ is the number of colors which exist in more than one connected component).
In fact, an inspection of their proof reveals that their algorithm is $O(n \, d^3 \, \nbadcolors \, \Bell(\nbadcolors))$,
Note that this algorithm is polynomial in $n$ and exponential in the total number of colors which violate convexity.

Here we describe a fixed parameter algorithm that is exponential in a local quantity rather than the global number of bad colors.
As shown in Proposition~\ref{prop:FPT}, there is a $O(n \, d^3 \, \bad \, \Bell(\bad))$, where now $\bad$ is the ``badness'' of the coloring described above.
The algorithm is very similar to theirs, but it is easier to use notation specialized to the case considered here rather than adopting their more general setting.

\subsubsection{Subsolution maps}

For the purposes of this section, assume a fixed leaf-colored tree $(S, \col)$ for which we would like to find an optimal subcoloring.
Because of this fixing, we will omit the specification of the coloring $\col$.
If the tree is not rooted, root it arbitrarily.

\begin{defn}
  Given $T$ a rooted subtree of $S$, define $\cut(T)$ to be the colors of $\col$ cut by the root edge of $T$ as it sits inside $S$.
\end{defn}

\begin{defn}
  For a rooted subtree $T$ we say that a subcoloring $\subcol$ in $\subcolST$ is convex on $T$ for above color $c$ if $\subcol$ is convex for $T$ when a leaf of color $c$ is attached to the root of $T$.
\end{defn}

\begin{defn}
  \label{defn:subsolution}
  Given a rooted subtree $T$ of a rooted colored tree $(S, \col)$, define a subsolution for a rooted subtree $T$, $X \subset \cut(T)$, and $c \in \cut(T)$ to be an element $\subcol \in \subcolST$ such that
  \begin{itemize}
    \item $\subcol$ is convex with above color $c$
    \item the range of $\subcol$ intersected with $K$ is $X$
    \item $\subcol$ is a subcoloring of maximal size among such subcolorings.
  \end{itemize}
\end{defn}

\begin{prop}
  \label{prop:subsolution}
  Solutions to Problem~\ref{prob:subcolor} restricted to rooted subtrees are rooted subsolutions.
\end{prop}

The proof is ``by definition,'' but is written out here for completeness.

\begin{proof}
  Let $\subcol$ be a solution to Problem~\ref{prob:subcolor}.
  Let $T$ be a rooted subtree, and let $e$ be the edge above $T$.
  Pick a color $c$ as follows.
  $|\subcolt(e)|$ must be one or zero by definition of convexity.
  If it is a single element, let $c$ be that element.
  If it is empty, then find the shortest path from $e$ to some edge $e'$ with an assigned color in $\subcolt$; set $c$ to be that color.

  Let $X$ be the colors of $\subcol$ intersected with $\cut(T)$.
  Let $\altcol$ be a subsolution for $T$, $X$, and $c$.

  $\altcol$ must be the same size as $\subcol$ restricted to the leaves of $T$ (denoted $\subcol|_T$).
  Indeed, replacing the restriction of $\subcol$ to the leaves of $T$ with $\altcol$ will result in a convex coloring, showing that $\altcol$ cannot be bigger than $\subcol|_T$.
  Also, $\subcol|_T$ satisfies the first two conditions of Definition~\ref{defn:subsolution} and so cannot be bigger than $\altcol$.
\end{proof}

\begin{defn}
  Define a solution map for a rooted subtree $T$ to be a map
  \[
    \varphi: \cut(T) \times 2^{\cut(T)} \rightarrow \subcolST
  \]
  to be a map from above colors and subsets of $\cut(T)$ to their corresponding subsolutions.
\end{defn}
We emphasize that the image of a subsolution map $\varphi(c,X)$ must contain $X$, and that this inclusion may be strict (i.e. if there are colors that appear only in $T$).
% Note that it is not enough to just look at the c such that c \in X: imagine a rooted caterpillar that is all red except for a blue at the very end.
% There the optimal is to delete that blue when c = blue and X = {red}.

Given two solution maps on disjoint subtrees, there is a well-defined notion of combining these solution maps which we denote $\subunion$.


\subsubsection{Recursion}

\begin{prop}
\label{prop:FPT}
Say $S$ is a tree such that each node has at most $d$ descendants, and $\col$ is a leaf coloring of $T$ of badness $\beta$.
Problem~\ref{prob:subcolor} can be solved for $(S, \col)$ with $n$ leaves in $O(n \, d^3 \, \bad \, Bell(\bad))$ time.
\end{prop}

\begin{proof}

A solution will be constructed by making subsolution maps for every rooted subtree of $S$.
This will give a solution to Problem~\ref{prob:subcolor} by Proposition~\ref{prop:subsolution}.

The proof will proceed by constructing solution maps for all subtrees $T$ of $S$ by recursion.
In fact, we will show that the solution map for a given internal node can be constructed from the maps for the nodes below it in time $2^{\bad(\col)}$;
this will demonstrate the proposition because there are $O(n)$ internal nodes and the leaf solution maps are trivial.

Fix a rooted subtree $T$ of $S$.
Let $e$ be the edge above $T$, and say that the direct descendants of the root edge of $T$ are subtrees $T_1,\ldots,T_r$.
By recursion, we assume that a $\varphi_i$ has been found for each $T_i$.
Let
\[
  B = \bigcup_{i,j} \left( \cut(T_i) \cap \cut(T_j) \right),
\]
which will be called the ``between'' colors.

To define $\varphi(c,X)$, recall that by Proposition~\ref{prop:subsolution} every solution is composed of subsolutions.
Therefore a $\varphi(c,X)$ can be found by finding the optimal $(c_1,X_1),\ldots,(c_r,X_r)$ such that $\varphi_1(c_1,X_1) \subunion \cdots \subunion \varphi_r(c_r,X_r)$ is legal and is of maximal size.

To find the optimal $(c_i, X_i)$, assign each $b$ of $B \cup \{c\}$ in turn to be the central node color.
Note that any color found in only one of the subtrees should be assigned to that subtree, i.e. $X_i \setminus B = K_i \cap (X \setminus B)$.
Given these choices, we need to select the elements of $X_i \cap B$ such that
\[
  \bigcup_{i} (X_i \cap B) = X \cap B
\]
and $X_i \cap X_j \subset \{b\}$ for each $i$ and $j$.
That is, every color in $(X \cap B) \setminus \{b\}$ must occur exactly once in the union of the $X_i$.
To find the optimal such choice, simply try every assignment of the $(X \cap B) \setminus \{b\}$ to the $X_i$; for every such assignment pick the assignment of $b$ to some set of $X_i$ maximizing the size of the resulting coloring.

Algorithmically, fill out a matrix with the $r$ subtrees as rows and the colors of $(X \cap B) \setminus \{b\}$ as the columns.
Put a gap at $(i,j)$ if the color $j$ does not appear in subtree $i$.
Then assign ones and zeroes such that the column sums are exactly one.

The upper bound for the number of subtrees is $d$, and these sets $X_i$ are of size at most $\bad$.
In principle we must investigate every disjoint subset $B \setminus \{b\}$; the number of these subsets is bounded above by $d^{\bad}$.
The choice for $b$ adds on another coefficent of $\bad$ to the outside, and the optimal assignment of $b$ to the $X_i$ gives another coefficient of $2^\bad$.
This procedure must be performed at every internal node, of which there are $n-1$.
\end{proof}

Rerooting at the max $K$ will reduce the amount of computation.

\section{Taxonomic rerooting}

We would like to find a rooting for a phylogenetic tree that is concordant with the taxonomy, i.e. such that the root of the tree is a node at the highest taxonomic level.
If the phylogeny and the taxonomy agree at the highest level divisions, there will be only one such node.
We show here that this node can be found in a number of steps that scales linear with the number of taxa.

Given a taxonomic identifier $u$, let $\rk(u)$ be the rank of $u$ in the taxonomic hierarchy.
Given a set of taxonomic identifiers $U$, let $\mrca(U)$ denote the most recent common ancestor of the identifiers in $U$.
By an abuse of notation, we also let $\rk(U)$ signify $\rk(\mrca(U))$.

The following lemma is clear.
\begin{lemma}
  \[
  \rk(A \cup B) \geq \max(\rk(A),\rk(B))
  \]
\qed
\end{lemma}

Given $x$ a node of $T$, say $\treecut(x;T)$ are the trees obtained by deleting $x$ from $T$.
Define $\subrk(x;T)$ to be $\max_{S \in L(\treecut(x;T))} \rk(S)$, the maximum rank of the root nodes of the subtrees of $T$ when rooted at $x$.

\begin{defn}
  A node $y \in N(T)$ is a \emph{taxonomic root} of $T$ if
  \[
    \subrk(y;T) = \min_{x \in N(T)} \subrk(x;T)
  \]
  The rank of such a node will be denoted $\minsubrk(T)$.
\end{defn}

Let $\diam(T)$ be the diameter of $T$.

\begin{prop}
A taxonomic root for a tree $T$ with $n$ leaves can be found by an algorithm which makes at most $\diam(T)$ steps.
\end{prop}

\begin{proof}
  Start at an arbitrary $x \in N(T)$.
  Let ${A_1,\cdots,A_n} = \treecut(x;T)$, and let
  \[
    (a_1,\cdots,a_n) = (\rk(A_1), \cdots, \rk(A_n))
  \]
  assume WLOG that $a_1 \leq a_2 \leq \cdots \leq a_n$.

  There are two cases: $a_{n-1} = a_n$ and $a_{n-1} < a_n$.
  In the first case, we know that $\minsubrk(T) = a_{n-1} = a_n$ because any direction we travel will leave one of the $a_i$'s intact, which will act as a lower bound for $\minsubrk(T)$.
  In the second case, $a_{n-1} \leq \minsubrk(T)$ but $\minsubrk(T)$ but may be less than $a_n$, which we can discover by moving towards it.
  Because stepping in this direction never backtracks, this algorithm can make at most $\diam(T)$ steps.
\end{proof}



\section{Restricted maximal tree length subset selection}

Given a tree $T$, integers $k \ge r > 1$, and a collection of subsets $S_1, \cdots, S_r$, we consider the question of finding a tree of maximal length among all taxon subsets of size $k$ such that we pick at least one element of each $S_i$.

We showed that clades are $O(n)$, trimmed clades are $O(nk^2)$, and
disjoint sets are $O(n^2 \log^2 n)$ if one set is connected,
$O(n^3 \log^2 n)$ otherwise.

\subsection{Clade case}
Goal:
Given a tree $T$ and specified clades in the tree $S_1,\cdots, S_\ell$, pick a maximally diverse set of $k \ge \ell$ sequences such that one sequence is chosen from every of the $S_i$.

Algorithm:
in each clade, start by picking the farthest sequence from the root of each clade.
Then greedily pick the rest of the sequences to maximize the PD.

Proof:
If the number of taxa to select in a given rooted clade is pre-determined, then we can apply the greedy algorithm to that clade to get a maximal PD subset.
This would begin by selecting the taxon furthest from the root.
Any maximal PD subset would also maximize the rooted PD for each of the chosen clades, given the optimal choice of the number of taxa to select from each of the clades.
We will call a choice of how many taxa to select from each designated clade a class.
We can maximize over classes and over PD given a the class, and by the argument above maximizing over PD given a class can always be done by starting with the farthest sequences from the root of each of the clades.



\section{Maximum length agreement subtree}

One may also have a number of rooted trees in the confidence set and want to find the common subtree with maximal total total tree length.
That is, given a collection of trees $T_1,\cdots,T_k$ to find a subset of the taxa $Q$ such that the $S_i = T_i \|_Q$ are topologically identical, and the total tree length of the $S_i$ is maximized over all such restrictions.
Define the $\mlst$ to be this total tree length.

Given a tree $T$ which contains the rooted triple $ab|c$, define $\ell_T(ab|c)$ to be the length of the path in $T$ from the common ancestor of $a$ and $b$ in $T$ to the common ancestor of $a$ and $c$ in $T$.
Given this definition, the key recursion is
\begin{lemma}
  \[
  \mlst(a,b) =
  \max \left\{ \sum_i \ell_{T_i} (ax|b) + mlst(a,x) : x \in A \right\} +
  \max \left\{ \sum_i \ell_{T_i} (by|a) + mlst(b,y) : y \in B \right\}
  \]
  where $A = {x: ax|b \in R} \cup {a}$ and $B = {y: by|a \in R} \cup {b}$.
\end{lemma}



\bibliography{algotax}
\bibliographystyle{plain}

\end{document}
