

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Creating and manipulating refpkgs &mdash; taxtastic 0.1.0 documentation</title>
    
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '0.1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="taxtastic 0.1.0 documentation" href="index.html" />
    <link rel="next" title="The Python Refpkg API" href="refpkg_api.html" />
    <link rel="prev" title="Manipulating the NCBI taxonomy" href="taxonomy.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="refpkg_api.html" title="The Python Refpkg API"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="taxonomy.html" title="Manipulating the NCBI taxonomy"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">taxtastic 0.1.0 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="creating-and-manipulating-refpkgs">
<h1>Creating and manipulating refpkgs<a class="headerlink" href="#creating-and-manipulating-refpkgs" title="Permalink to this headline">¶</a></h1>
<div class="section" id="quickstart">
<h2>Quickstart<a class="headerlink" href="#quickstart" title="Permalink to this headline">¶</a></h2>
<p>The refpkgs is a container format for keeping all the miscellaneous files required to run <tt class="docutils literal"><span class="pre">pplacer</span></tt> in one place.  Roughly, it is a directory containing files and JSON file describing the other contents.  Refpkgs can be created and manipulated either from the commandline with subcommands of <tt class="docutils literal"><span class="pre">taxit</span></tt>, or from Python using an API exposed by the module <tt class="docutils literal"><span class="pre">taxtastic.refpkg</span></tt>.</p>
<p>To create an empty refpkg from Python, you would write:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">taxtastic.refpkg</span> <span class="kn">import</span> <span class="n">Refpkg</span>

<span class="n">r</span> <span class="o">=</span> <span class="n">Refpkg</span><span class="p">(</span><span class="s">&#39;/path/to/new/refpkg&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>If there had already been a refpkg at <tt class="docutils literal"><span class="pre">/path/to/new/refpkg</span></tt>, <tt class="docutils literal"><span class="pre">r</span></tt> would contain a reference to the existing refpkg afterwards.  If it doesn&#8217;t exist, it is created.  For historical reasons, the command line interface requires that you specify a locus to be recorded in the refpkg&#8217;s metadata:</p>
<div class="highlight-python"><pre>taxit create -l locus_name -P /path/to/new/refpkg</pre>
</div>
<p><tt class="docutils literal"><span class="pre">taxit</span> <span class="pre">create</span></tt> takes many other arguments to add particular files that <tt class="docutils literal"><span class="pre">pplacer</span></tt> expects, but we won&#8217;t go into them here.  To add a file to a refpkg, we specify a key which it will be added under (refpkgs act as key-value stores) and the file to add.  With the API, this is:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">r</span><span class="o">.</span><span class="n">update_file</span><span class="p">(</span><span class="s">&#39;key&#39;</span><span class="p">,</span> <span class="s">&#39;/path/to/file/to/add&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>or from the command line</p>
<blockquote>
<div>taxit update /path/to/refpkg key=/path/to/file/to/add</div></blockquote>
<p>Either way, <tt class="docutils literal"><span class="pre">/path/to/file/to/add</span></tt> is copied into the refpkg (and renamed if necessary so as not to collide with files already in the refpkg), and an entry added to the JSON file to assign <tt class="docutils literal"><span class="pre">key</span></tt> to the file.</p>
<p>Refpkgs also store metadata, in the form of a key-value store of arbitrary strings.  The metadata keys occupy a separate namespace from the file keys, so you can have both a file and a string assigned to the key <tt class="docutils literal"><span class="pre">boris</span></tt> at the same time.  Setting metadata with the API uses the method <tt class="docutils literal"><span class="pre">update_metadata</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">r</span><span class="o">.</span><span class="n">update_metadata</span><span class="p">(</span><span class="s">&#39;key&#39;</span><span class="p">,</span> <span class="s">&#39;value to add&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>From the command line, use <tt class="docutils literal"><span class="pre">taxit</span> <span class="pre">update</span></tt>, but with the <tt class="docutils literal"><span class="pre">--metadata</span></tt> option:</p>
<div class="highlight-python"><pre>taxit update --metadata /path/to/refpkg "key=value to add"</pre>
</div>
<p>Refpkgs have an undo/redo mechanism.  If you update something incorrectly, you can call the <tt class="docutils literal"><span class="pre">rollback</span></tt> method of the API or the <tt class="docutils literal"><span class="pre">rollback</span></tt> subcommand of <tt class="docutils literal"><span class="pre">taxit</span></tt> to restore the refpkg to its previous state.  An improperly rolled back operation can be rolled forward again with <tt class="docutils literal"><span class="pre">rollforward</span></tt>.  So running the following in the API leaves the refpkg unchanged at the end:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">r</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
<span class="n">r</span><span class="o">.</span><span class="n">rollforward</span><span class="p">()</span>
</pre></div>
</div>
<p>Similarly with <tt class="docutils literal"><span class="pre">taxit</span></tt>:</p>
<div class="highlight-python"><pre>taxit rollback /path/to/refpkg
taxit rollforward /path/to/refpkg</pre>
</div>
<p>Before distributing a refpkg, you may want to strip out rollback/rollforward information and any unused files.  The <tt class="docutils literal"><span class="pre">strip</span></tt> method removes everything not necessary to the current state of the refpkg:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">r</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</pre></div>
</div>
<p>or from the command line:</p>
<div class="highlight-python"><pre>taxit strip /path/to/refpkg</pre>
</div>
<p>There is a method and a command, both called <tt class="docutils literal"><span class="pre">check</span></tt>, which check if a refpkg is usable as an input to <tt class="docutils literal"><span class="pre">pplacer</span></tt>.  Running <tt class="docutils literal"><span class="pre">r.check()</span></tt> from Python or <tt class="docutils literal"><span class="pre">taxit</span> <span class="pre">check</span> <span class="pre">/path/to/refpkg</span></tt> from the command line will fail, saying that there is no such key <tt class="docutils literal"><span class="pre">aln_fasta</span></tt> in the refpkg.</p>
</div>
<div class="section" id="the-refpkg-format">
<h2>The Refpkg format<a class="headerlink" href="#the-refpkg-format" title="Permalink to this headline">¶</a></h2>
<p>A refpkg is a crude key-value store for files with some basic integrity checking, machinery for undo and redo of operations, and a little bit of metadata storage.  The minimal refpkg consists of a directory containing a file names <tt class="docutils literal"><span class="pre">CONTENTS.json</span></tt>.  The JSON file must contain the following keys:</p>
<dl class="docutils">
<dt><tt class="docutils literal"><span class="pre">files</span></tt></dt>
<dd>A list of the files this refpkg is currently tracking in its directory.   The value must be a JSON object assigning keys to filenames in the directory, e.g. <tt class="docutils literal"><span class="pre">{&quot;taxonomy&quot;:</span> <span class="pre">&quot;taxtable.csv&quot;}</span></tt>.</dd>
<dt><tt class="docutils literal"><span class="pre">md5</span></tt></dt>
<dd>The value must be a JSON object with the same keys are <tt class="docutils literal"><span class="pre">files</span></tt>, but where the values are the MD5 sums of the files.  These fields are used to ensure the integrity of the files the refpkg is tracking.</dd>
<dt><tt class="docutils literal"><span class="pre">metadata</span></tt></dt>
<dd>The value must be a JSON object containing keys referring to strings, e.g., <tt class="docutils literal"><span class="pre">{&quot;author&quot;:</span> <span class="pre">&quot;Boris</span> <span class="pre">the</span> <span class="pre">mad</span> <span class="pre">baboon&quot;,</span> <span class="pre">&quot;create_date&quot;:</span> <span class="pre">&quot;2011-08-18</span> <span class="pre">14:50:39&quot;}</span></tt>.  This is where any data describing the refpkg as a whole should be.</dd>
<dt><tt class="docutils literal"><span class="pre">log</span></tt></dt>
<dd>The value must be a list of strings, e.g., <tt class="docutils literal"><span class="pre">[&quot;Created</span> <span class="pre">package.&quot;,</span> <span class="pre">&quot;Oh</span> <span class="pre">god,</span> <span class="pre">get</span> <span class="pre">it</span> <span class="pre">off</span> <span class="pre">me!&quot;]</span></tt>.  The various refpkg operations each append an entry to the log, so it records the history of what has been done to this refpkg.</dd>
<dt><tt class="docutils literal"><span class="pre">rollback</span></tt></dt>
<dd>Either <tt class="docutils literal"><span class="pre">null</span></tt> or the JSON object which was previously the top level object of <tt class="docutils literal"><span class="pre">CONTENTS.json</span></tt> before the last operation performed on this refpkg.  It is used to undo operations on a refpkg.</dd>
<dt><tt class="docutils literal"><span class="pre">rollforward</span></tt></dt>
<dd>When an operation is rolled back, the state before the rollback is preserved in <tt class="docutils literal"><span class="pre">rollforward</span></tt> so the undo can be redone.  <tt class="docutils literal"><span class="pre">rollforward</span></tt> is either <tt class="docutils literal"><span class="pre">null</span></tt> or a list of two entries, the first a string giving the log entry associated with the rolled back operation, the second the JSON object describing the contents before the rollback.</dd>
</dl>
<p>Any program only wanting to read refpkgs only needs to worry about the keys <tt class="docutils literal"><span class="pre">files</span></tt>, <tt class="docutils literal"><span class="pre">md5</span></tt>, and <tt class="docutils literal"><span class="pre">metadata</span></tt>.  Any file read from the refpkg should have its MD5 sum checked against the refpkg&#8217;s stored value.</p>
<p>The refpkg format was designed to store the multiple alignments and trees created by <tt class="docutils literal"><span class="pre">cmalign</span></tt> and RAxML, and used by <tt class="docutils literal"><span class="pre">pplacer</span></tt>, so certain fields are expected.</p>
<dl class="docutils">
<dt><tt class="docutils literal"><span class="pre">taxonomy</span></tt></dt>
<dd>A CSV file giving a taxonomy that contains all the sequences included in the refpkg.  This is typically created with taxtastic&#8217;s <tt class="docutils literal"><span class="pre">taxit</span> <span class="pre">taxtable</span></tt> command.</dd>
<dt><tt class="docutils literal"><span class="pre">profile</span></tt></dt>
<dd>The profile used by <tt class="docutils literal"><span class="pre">cmalign</span></tt> when aligning the sequences for <tt class="docutils literal"><span class="pre">pplacer</span></tt>.</dd>
<dt><tt class="docutils literal"><span class="pre">tree</span></tt></dt>
<dd>A phylogenetic tree with the sequences in this refpkg as its nodes, stored in Newick format.</dd>
<dt><tt class="docutils literal"><span class="pre">tree_stats</span></tt></dt>
<dd>The output of RAxML describing its run when it assembled the phylogenetic tree for this refpkg.</dd>
<dt><tt class="docutils literal"><span class="pre">phylo_model</span></tt></dt>
<dd>A JSON file describing the phylogenetic model used for tree construction, usually parsed from the information in <tt class="docutils literal"><span class="pre">tree_stats</span></tt>.</dd>
<dt><tt class="docutils literal"><span class="pre">aln_fasta</span></tt></dt>
<dd>A FASTA file containing all the sequences included in this refpkg (without gaps; this is the input to <tt class="docutils literal"><span class="pre">cmalign</span></tt>, not its output).</dd>
<dt><tt class="docutils literal"><span class="pre">seq_info</span></tt></dt>
<dd><p class="first">A CSV file giving basic information on all the sequences included in the refpkg.  It should begin with one line giving the field names:</p>
<div class="highlight-python"><pre>``"seqname","accession","tax_id","species_name","is_type"</pre>
</div>
<p class="last"><tt class="docutils literal"><span class="pre">seqname</span></tt> should match the ID of the sequence in the FASTA file.  <tt class="docutils literal"><span class="pre">accession</span></tt> is a database reference for the sequence, which can be the same as <tt class="docutils literal"><span class="pre">seqname</span></tt>.  In our work, <tt class="docutils literal"><span class="pre">seqname</span></tt> is an RDP accession number and <tt class="docutils literal"><span class="pre">accession</span></tt> is the NCBI accession number corresponding to that RDP entry.  <tt class="docutils literal"><span class="pre">tax_id</span></tt> is the entry in the taxonomy this sequence is mapped to, and <tt class="docutils literal"><span class="pre">species_name</span></tt> is the name associated with that entry.  <tt class="docutils literal"><span class="pre">is_type</span></tt> indicates whether this sequence is from a typestrain or not (again, this is particular to our work).</p>
</dd>
<dt><tt class="docutils literal"><span class="pre">aln_sto</span></tt></dt>
<dd>The same sequences as in <tt class="docutils literal"><span class="pre">aln_fasta</span></tt>, but now multiply aligned and written in Stockholm format.</dd>
</dl>
<p>The files referred to by <tt class="docutils literal"><span class="pre">aln_fasta</span></tt>, <tt class="docutils literal"><span class="pre">seq_info</span></tt>, <tt class="docutils literal"><span class="pre">aln_sto</span></tt>, and <tt class="docutils literal"><span class="pre">tree</span></tt> should all have the same list of sequences.  This isn&#8217;t strictly enforced, but you can check that it is so with the <tt class="docutils literal"><span class="pre">taxit</span> <span class="pre">check</span></tt> command or the <tt class="docutils literal"><span class="pre">is_ill_formed</span></tt> method of the refpkg API.</p>
<p>The undo/redo system is implemented as a purely functional data structure known as a zipper, used as a replacement for arrays with a pointer into them as a cursor in languages where data is immutable.  A zipper consists of a current entry, a ordered list of previous entries, and an ordered list of subsequent entries.  Moving the cursor one place to the right is equivalent to pushing the current entry onto the head of the list of previous entries, and popping the head of the list of subsequent entries and making that the new current entry.  Moving the cursor one place to the left is exactly the opposite.</p>
<p>The top level object of <tt class="docutils literal"><span class="pre">CONTENTS.json</span></tt> plays the role of the current entry, and its fields <tt class="docutils literal"><span class="pre">rollback</span></tt> and <tt class="docutils literal"><span class="pre">rollforward</span></tt> are the heads of the lists of previous and subsequent entries.  The <tt class="docutils literal"><span class="pre">rollback</span></tt> field of the object in the <tt class="docutils literal"><span class="pre">rollback</span></tt> field is the second element of the list of previous entries, etc.  Thus undoing an operation consists of putting the current toplevel JSON object in the <tt class="docutils literal"><span class="pre">rollforward</span></tt> fields of the object in the <tt class="docutils literal"><span class="pre">rollback</span></tt> field, and making that object the new toplevel JSON object (with some book keeping details to keep everything consistent).</p>
<p>As a result of this, there may be files besides those referenced in the <tt class="docutils literal"><span class="pre">files</span></tt> key of the JSON object in the refpkg.  They may be referenced by other entries in the zipper.  There is no attempt to intelligently garbage collect orphaned files.  They are only deleted when the refpkg&#8217;s <tt class="docutils literal"><span class="pre">strip</span></tt> method is called, which removes all undo/redo information as well.</p>
</div>
<div class="section" id="the-refpkg-api">
<h2>The refpkg API<a class="headerlink" href="#the-refpkg-api" title="Permalink to this headline">¶</a></h2>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Creating and manipulating refpkgs</a><ul>
<li><a class="reference internal" href="#quickstart">Quickstart</a></li>
<li><a class="reference internal" href="#the-refpkg-format">The Refpkg format</a></li>
<li><a class="reference internal" href="#the-refpkg-api">The refpkg API</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="taxonomy.html"
                        title="previous chapter">Manipulating the NCBI taxonomy</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="refpkg_api.html"
                        title="next chapter">The Python Refpkg API</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/refpkg.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="refpkg_api.html" title="The Python Refpkg API"
             >next</a> |</li>
        <li class="right" >
          <a href="taxonomy.html" title="Manipulating the NCBI taxonomy"
             >previous</a> |</li>
        <li><a href="index.html">taxtastic 0.1.0 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2011, Noah Hoffman, Erick Matsen, Brian Hodges.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.
    </div>
  </body>
</html>