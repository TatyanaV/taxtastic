

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>The Python Refpkg API &mdash; taxtastic v0.1.0 documentation</title>
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '0.1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="taxtastic v0.1.0 documentation" href="index.html" />
    <link rel="next" title="Detailed taxit documentation" href="commands.html" />
    <link rel="prev" title="Creating and manipulating refpkgs" href="refpkg.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="commands.html" title="Detailed taxit documentation"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="refpkg.html" title="Creating and manipulating refpkgs"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">taxtastic v0.1.0 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="the-python-refpkg-api">
<h1>The Python Refpkg API<a class="headerlink" href="#the-python-refpkg-api" title="Permalink to this headline">¶</a></h1>
<p>Taxtastic provides a Python API for creating and manipulating refpkgs wihtout having to recourse to the command line.  It is entirely based around the <tt class="docutils literal"><span class="pre">Refpkg</span></tt> class in <tt class="docutils literal"><span class="pre">taxtastic.refpkg</span></tt>.  Thus all scripts dealing with refpkgs will include code that looks something like:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">taxtastic.refpkg</span> <span class="kn">import</span> <span class="n">Refpkg</span>

<span class="n">r</span> <span class="o">=</span> <span class="n">Refpkg</span><span class="p">(</span><span class="s">&#39;/path/to/refpkg&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>The constructor takes no other arguments.  If the refpkg at <tt class="docutils literal"><span class="pre">/path/to/refpkg</span></tt> already exists, <tt class="docutils literal"><span class="pre">r</span></tt> is attached to it.  If <tt class="docutils literal"><span class="pre">/path/to/refpkg</span></tt> does not exist, a new, empty refpkg is created.  If there is already something at <tt class="docutils literal"><span class="pre">/path/to/refpkg</span></tt>, but it is not a refpkg, <tt class="docutils literal"><span class="pre">Refpkg</span></tt> throws a <tt class="docutils literal"><span class="pre">ValueError</span></tt>.</p>
<p>The rest of the API is implemented as methods of the <tt class="docutils literal"><span class="pre">Refpkg</span></tt> class.</p>
<p><strong>Note</strong>: This library is <em>not</em> thread safe!</p>
<div class="section" id="accessing-refpkg-contents">
<h2>Accessing refpkg contents<a class="headerlink" href="#accessing-refpkg-contents" title="Permalink to this headline">¶</a></h2>
<p>Refpkgs are primarily key-value stores for files and metadata.  To find all the keys referring to files or to metadata in a given refpkg, use the methods</p>
<p>For example,:</p>
<div class="highlight-python"><pre>r = Refpkg('/path/to/new/refpkg')
r.metadata_keys()
 --&gt; ['create_date', 'format_version']
r.update_file('file_key', '/path/to/some/file')
r.file_keys()
 --&gt; ['file_key']</pre>
</div>
<p>Call the <tt class="docutils literal"><span class="pre">metadata</span></tt> method to retrieve the value of a particular metadata field.</p>
<p>For instance, on the same refpkg as above,:</p>
<div class="highlight-python"><pre>r.metadata('format_version')
 --&gt; '1.1'</pre>
</div>
<p>There are several methods for retrieving files, depending on whether you want just the name of the file in the repository, a full path to the file, or the file&#8217;s MD5 sum (for integrity checking purposes).</p>
</div>
<div class="section" id="checking-refpkg-integrity">
<h2>Checking refpkg integrity<a class="headerlink" href="#checking-refpkg-integrity" title="Permalink to this headline">¶</a></h2>
<p>There are two methods for checking a refpkg.  The <tt class="docutils literal"><span class="pre">isinvalid</span></tt> method enforces only that the refpkg is sane: there is a <tt class="docutils literal"><span class="pre">CONTENTS.json</span></tt> file, the MD5 sums listed match the actual files, and other such basics.  The <tt class="docutils literal"><span class="pre">is_ill_formed</span></tt> method is much stronger.  It enforces the necessary structure of a refpkg to be fed to <tt class="docutils literal"><span class="pre">pplacer</span></tt>.</p>
</div>
<div class="section" id="updating-and-modifying-refpkgs">
<h2>Updating and modifying refpkgs<a class="headerlink" href="#updating-and-modifying-refpkgs" title="Permalink to this headline">¶</a></h2>
<p>All updates are made via two methods: <tt class="docutils literal"><span class="pre">update_metadata</span></tt> and <tt class="docutils literal"><span class="pre">update_file</span></tt>.  Each takes a key and a new value to set at that key, and returns the path to the previous value of the key, or <tt class="xref docutils literal"><span class="pre">None</span></tt> if the key was not previously defined in the refpkg.</p>
</div>
<div class="section" id="refpkg-history-undo-and-redo">
<h2>Refpkg history, undo, and redo<a class="headerlink" href="#refpkg-history-undo-and-redo" title="Permalink to this headline">¶</a></h2>
<p>Each operation performed on a refpkg leaves an entry in a log stored in <tt class="docutils literal"><span class="pre">CONTENTS.json</span></tt>.  You can access this log by calling the <tt class="docutils literal"><span class="pre">log</span></tt> method.</p>
<p>Each operation call also be undone (and redone once undone).  The undo stack is arbitrarily deep so all operations back to the previous call to <tt class="docutils literal"><span class="pre">strip</span></tt> (see below) can be undone.  To undo an operation, call <tt class="docutils literal"><span class="pre">rollback</span></tt>.  To redo it afterwards, call <tt class="docutils literal"><span class="pre">rollforward</span></tt>.  The logs will similarly be updated to stay in sync with the rollback and rollforward of operations.  Note that when you call another operation, all the redo information before that point is removed.  You cannot undo an operation, perform another operation, then redo the first operation.</p>
<p>After performing a lot of operations on a refpkg, there will often be a long undo history, and files no longer referred to in the refpkg&#8217;s current state.  To remove everything not relevant to the refpkg&#8217;s current state other than the log, call the <tt class="docutils literal"><span class="pre">strip</span></tt> method.</p>
<p>You can force a series of operations to be recorded as a single operation for rollback and have a single log entry by calling <tt class="docutils literal"><span class="pre">start_transaction</span></tt> before them, and <tt class="docutils literal"><span class="pre">commit_transaction</span></tt> with the log entry to record when they are done.</p>
<p>For example,</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">taxtastic.refpkg</span> <span class="kn">import</span> <span class="n">Refpkg</span>

<span class="n">r</span> <span class="o">=</span> <span class="n">Refpkg</span><span class="p">(</span><span class="s">&#39;/path/to/refpkg&#39;</span><span class="p">)</span>

<span class="n">r</span><span class="o">.</span><span class="n">start_transaction</span><span class="p">()</span>
<span class="n">r</span><span class="o">.</span><span class="n">update_metadata</span><span class="p">(</span><span class="s">&#39;author&#39;</span><span class="p">,</span> <span class="s">&#39;Boris the mad baboon&#39;</span><span class="p">)</span>
<span class="n">r</span><span class="o">.</span><span class="n">update_file</span><span class="p">(</span><span class="s">&#39;boris_signature&#39;</span><span class="p">,</span> <span class="s">&#39;/path/to/some/file&#39;</span><span class="p">)</span>
<span class="n">r</span><span class="o">.</span><span class="n">commit_transaction</span><span class="p">(</span><span class="s">&quot;Left Boris&#39;s mark!&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>would result in a single operation that could be rolled back as one, and leaves the log entry <tt class="docutils literal"><span class="pre">&quot;Left</span> <span class="pre">Boris's</span> <span class="pre">mark!&quot;</span></tt>.</p>
</div>
<div class="section" id="pplacer-specific-commands">
<h2><tt class="docutils literal"><span class="pre">pplacer</span></tt> specific commands<a class="headerlink" href="#pplacer-specific-commands" title="Permalink to this headline">¶</a></h2>
<p>Finally, the API has three commands which are specific to creating inputs for <tt class="docutils literal"><span class="pre">pplacer</span></tt>.  One of these is <tt class="docutils literal"><span class="pre">check</span></tt>, which was described above.  The other two are:</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">The Python Refpkg API</a><ul>
<li><a class="reference internal" href="#accessing-refpkg-contents">Accessing refpkg contents</a></li>
<li><a class="reference internal" href="#checking-refpkg-integrity">Checking refpkg integrity</a></li>
<li><a class="reference internal" href="#updating-and-modifying-refpkgs">Updating and modifying refpkgs</a></li>
<li><a class="reference internal" href="#refpkg-history-undo-and-redo">Refpkg history, undo, and redo</a></li>
<li><a class="reference internal" href="#pplacer-specific-commands"><tt class="docutils literal"><span class="pre">pplacer</span></tt> specific commands</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="refpkg.html"
                        title="previous chapter">Creating and manipulating refpkgs</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="commands.html"
                        title="next chapter">Detailed <tt class="docutils literal docutils literal"><span class="pre">taxit</span></tt> documentation</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/refpkg_api.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" size="18" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="commands.html" title="Detailed taxit documentation"
             >next</a> |</li>
        <li class="right" >
          <a href="refpkg.html" title="Creating and manipulating refpkgs"
             >previous</a> |</li>
        <li><a href="index.html">taxtastic v0.1.0 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2011, Noah Hoffman, Erick Matsen, Brian Hodges.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.0.7.
    </div>
  </body>
</html>